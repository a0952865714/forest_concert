<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æ•¸ä½æ‹¼åœ–éŠæˆ² v2.0</title>
    <style>
        /* * 1. è¦–è¦ºæ¨£å¼è¨­è¨ˆ (CSS) 
         * é…è‰²ï¼šä¸»è‰² #FF9F1C (äº®æ©˜), è¼”åŠ©è‰² #2EC4B6 (è—ç¶ ), AIè‰² #7B2CBF (ç´«è‰²)
         */
        :root {
            --primary-color: #FF9F1C;
            --secondary-color: #2EC4B6;
            --ai-color: #7B2CBF;
            --ai-light: #E0AAFF;
            --bg-color: #ffffff;
            --text-color: #333;
            --gap-size: 2px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* å…¨é èƒŒæ™¯åœ–æµ®æ°´å° */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://raw.githubusercontent.com/mathruffian-dot/teaching-assets/refs/heads/main/image.avif');
            background-size: cover;
            background-position: center;
            opacity: 0.5;
            z-index: -1;
        }

        header {
            text-align: center;
            padding: 20px 10px;
            background: rgba(255, 255, 255, 0.95);
            width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        h1 {
            margin: 0;
            color: var(--primary-color);
            text-shadow: 1px 1px 0px #333;
            font-size: 1.8rem;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* * ä½¿ç”¨è€…ä»‹é¢ (UI) 
         */
        .controls-wrapper {
            max-width: 600px;
            width: 95%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            align-items: center;
        }

        .ai-panel {
            border: 2px solid var(--ai-light);
            background: linear-gradient(to right bottom, #fff, #f8f0ff);
        }

        .panel-title {
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .ai-panel .panel-title {
            color: var(--ai-color);
        }

        select, button, label, input[type="text"] {
            padding: 10px 15px;
            border-radius: 25px;
            border: 2px solid var(--secondary-color);
            background: white;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        input[type="text"] {
            flex-grow: 1;
            min-width: 200px;
            border-color: var(--ai-color);
            cursor: text;
            user-select: text; /* å…è¨±è¼¸å…¥æ–‡å­—é¸å– */
            -webkit-user-select: text;
        }
        
        input[type="text"]:focus {
            box-shadow: 0 0 0 3px rgba(123, 44, 191, 0.2);
        }

        select:focus, button:focus {
            box-shadow: 0 0 0 3px rgba(46, 196, 182, 0.3);
        }

        button.primary {
            background-color: var(--secondary-color);
            color: white;
            font-weight: bold;
        }
        
        button.ai-btn {
            background-color: var(--ai-color);
            border-color: var(--ai-color);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        button.ai-btn:hover {
            background-color: #5a189a;
            box-shadow: 0 4px 12px rgba(123, 44, 191, 0.3);
        }

        button.coach-btn {
            background-color: white;
            color: var(--ai-color);
            border-color: var(--ai-color);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* è‡ªè¨‚ä¸Šå‚³æŒ‰éˆ•ç¾åŒ– */
        input[type="file"] {
            display: none;
        }
        .file-upload-label {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            display: inline-flex;
            align-items: center;
            font-weight: bold;
        }
        .file-upload-label:hover {
            opacity: 0.9;
        }

        /* * æ‹¼åœ–éŠæˆ²å€åŸŸ 
         */
        #game-container {
            width: 100%;
            max-width: 600px; /* RWD æœ€å¤§å¯¬åº¦ */
            padding: 10px;
            position: relative;
        }

        #puzzle-board {
            width: 100%;
            /* é«˜åº¦ç”± JS å‹•æ…‹è¨­å®šä»¥ç¶­æŒæ¯”ä¾‹ */
            background-color: rgba(0,0,0,0.1);
            border: 4px solid var(--primary-color);
            border-radius: 8px;
            display: grid;
            grid-gap: var(--gap-size);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: opacity 0.3s;
        }
        
        #puzzle-board.loading {
            opacity: 0.5;
            pointer-events: none;
        }

        /* å–®å€‹æ‹¼åœ–å¡Š */
        .puzzle-piece {
            background-repeat: no-repeat;
            cursor: grab;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 2px;
        }

        .puzzle-piece.selected {
            z-index: 10;
            box-shadow: 0 0 0 4px var(--primary-color), 0 0 15px rgba(255, 159, 28, 0.6);
            transform: scale(1.02);
            border: 1px solid white;
        }

        .puzzle-piece.correct-flash {
            animation: flash 0.5s;
        }

        @keyframes flash {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
            100% { filter: brightness(1); }
        }

        /* å·çœ‹åŸåœ–çš„è¦†è“‹å±¤ */
        #reference-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: white;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            border-radius: 4px;
        }

        #reference-image.show {
            opacity: 1;
        }
        
        /* è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 30;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: var(--ai-color);
            font-weight: bold;
            border-radius: 8px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--ai-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* * Modal å½ˆå‡ºè¦–çª— 
         */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border-top: 10px solid var(--secondary-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        
        .modal-content.ai-style {
            border-top-color: var(--ai-color);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 {
            color: var(--secondary-color);
            margin-top: 0;
        }
        
        .modal-content.ai-style h2 {
            color: var(--ai-color);
        }

        .modal p {
            font-size: 1.1rem;
            color: #555;
            margin: 20px 0;
            line-height: 1.5;
            white-space: pre-wrap; /* ä¿ç•™ AI å›æ‡‰çš„æ›è¡Œ */
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }
        .close-modal:hover { color: #333; }

        /* æ‰‹æ©Ÿç‰ˆæç¤º */
        .mobile-tip {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-tip { display: block; }
        }

    </style>
</head>
<body>

    <header>
        <h1>ğŸ§© äº’å‹•å¼æ•¸ä½æ‹¼åœ–</h1>
        <div class="subtitle">Gemini AI è³¦èƒ½ç‰¹åˆ¥ç‰ˆ âœ¨</div>
        <div class="mobile-tip">ğŸ’¡ æ‰‹æ©Ÿç‰ˆï¼šé»æ“Šå…©å¼µåœ–ç‰‡å³å¯äº¤æ›ä½ç½®</div>
    </header>

    <div class="controls-wrapper">
        
        <!-- AI å‰µæ„å·¥åŠå€å¡Š -->
        <div class="panel ai-panel">
            <div class="panel-title">âœ¨ AI å‰µæ„å·¥åŠï¼šæè¿°ä½ æƒ³æ‹¼çš„åœ–ç‰‡</div>
            <input type="text" id="aiPromptInput" placeholder="ä¾‹å¦‚ï¼šè³½åšé¾å…‹é¢¨æ ¼çš„è²“å’ªåœ¨åƒæ‹‰éºµ...">
            <button id="aiGenBtn" class="ai-btn">
                <span>ğŸ¨ ç”Ÿæˆæ‹¼åœ–</span>
            </button>
        </div>

        <!-- ä¸€èˆ¬æ§åˆ¶å€å¡Š -->
        <div class="panel">
            <div class="panel-title">ä¸€èˆ¬è¨­å®š</div>
            <!-- é—œå¡é¸æ“‡å™¨ -->
            <select id="levelSelect">
                <option value="https://i.ibb.co/cXX0gR0M/edited-image.png">é—œå¡ 1 (é è¨­)</option>
                <option value="https://raw.githubusercontent.com/mathruffian-dot/teaching-assets/refs/heads/main/%E8%9E%A2%E5%B9%95%E6%93%B7%E5%8F%96%E7%95%AB%E9%9D%A2%202025-12-10%20103628.png">é—œå¡ 2 (æ•™å­¸)</option>
                <option value="https://ibb.co/kgpptz9b">é—œå¡ 3 (é è¨­)</option>
            </select>

            <!-- è‡ªè¨‚åœ–ç‰‡ä¸Šå‚³ -->
            <label for="uploadInput" class="file-upload-label">
                ğŸ“· ä¸Šå‚³åœ–ç‰‡
            </label>
            <input type="file" id="uploadInput" accept="image/*">

            <!-- åŠŸèƒ½æŒ‰éˆ• -->
            <button id="resetBtn" class="primary">ğŸ”„ é‡æ–°é–‹å§‹</button>
            <button id="peekBtn">ğŸ‘ï¸ å·çœ‹</button>
            
            <!-- AI æ•™ç·´æŒ‰éˆ• -->
            <button id="aiCoachBtn" class="coach-btn">ğŸ¤– AI æç¤ºèˆ‡é¼“å‹µ</button>
        </div>
    </div>

    <div id="game-container">
        <!-- æ‹¼åœ–å€åŸŸ -->
        <div id="puzzle-board"></div>
        <!-- åƒè€ƒåŸåœ– (å·çœ‹ç”¨) -->
        <img id="reference-image" src="" alt="Reference">
        
        <!-- è¼‰å…¥é®ç½© -->
        <div id="loading-overlay">
            <div class="spinner"></div>
            <div id="loading-text">AI æ­£åœ¨æ–½å±•é­”æ³•...</div>
        </div>
    </div>

    <!-- é€šç”¨ Modal (å‹åˆ©/AIè¨Šæ¯) -->
    <div id="infoModal" class="modal">
        <div class="modal-content" id="modalContentBox">
            <span class="close-modal" id="modalCloseX">&times;</span>
            <h2 id="modalTitle">ğŸ‰ æ¨™é¡Œ</h2>
            <p id="modalText">è¨Šæ¯å…§å®¹...</p>
            <button id="modalActionBtn" class="primary">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        /**
         * API è¨­å®šèˆ‡æ ¸å¿ƒé‚è¼¯
         */
        const apiKey = ""; // ç³»çµ±æœƒè‡ªå‹•å¡«å…¥ API Key

        // ç‹€æ…‹è®Šæ•¸
        const state = {
            currentImageUrl: '',
            rows: 3,
            cols: 4,
            pieces: [], // å„²å­˜ç›®å‰çš„æ‹¼åœ–æ’åˆ—
            selectedPieceIndex: null, // ç”¨æ–¼é»æ“Šäº¤æ›æ¨¡å¼
            isDragging: false,
            isLoading: false
        };

        // DOM å…ƒç´ 
        const elements = {
            board: document.getElementById('puzzle-board'),
            levelSelect: document.getElementById('levelSelect'),
            uploadInput: document.getElementById('uploadInput'),
            resetBtn: document.getElementById('resetBtn'),
            peekBtn: document.getElementById('peekBtn'),
            refImage: document.getElementById('reference-image'),
            
            // AI ç›¸é—œå…ƒç´ 
            aiPromptInput: document.getElementById('aiPromptInput'),
            aiGenBtn: document.getElementById('aiGenBtn'),
            aiCoachBtn: document.getElementById('aiCoachBtn'),
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),

            // Modal ç›¸é—œ
            infoModal: document.getElementById('infoModal'),
            modalContentBox: document.getElementById('modalContentBox'),
            modalTitle: document.getElementById('modalTitle'),
            modalText: document.getElementById('modalText'),
            modalActionBtn: document.getElementById('modalActionBtn'),
            modalCloseX: document.getElementById('modalCloseX')
        };

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadLevel(elements.levelSelect.value);
            setupEventListeners();
        });

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // é—œå¡èˆ‡ä¸Šå‚³
            elements.levelSelect.addEventListener('change', (e) => loadLevel(e.target.value));
            elements.uploadInput.addEventListener('change', handleImageUpload);
            
            // éŠæˆ²æ§åˆ¶
            elements.resetBtn.addEventListener('click', () => {
                shufflePieces();
                renderBoard();
            });

            // AI åŠŸèƒ½ç›£è½
            elements.aiGenBtn.addEventListener('click', handleAIGenerate);
            elements.aiCoachBtn.addEventListener('click', handleAICoach);

            // å·çœ‹åŠŸèƒ½
            const showPeek = () => elements.refImage.classList.add('show');
            const hidePeek = () => elements.refImage.classList.remove('show');
            elements.peekBtn.addEventListener('mousedown', showPeek);
            elements.peekBtn.addEventListener('mouseup', hidePeek);
            elements.peekBtn.addEventListener('mouseleave', hidePeek);
            elements.peekBtn.addEventListener('touchstart', (e) => { e.preventDefault(); showPeek(); });
            elements.peekBtn.addEventListener('touchend', (e) => { e.preventDefault(); hidePeek(); });

            // Modal æ§åˆ¶
            const closeModal = () => elements.infoModal.style.display = 'none';
            elements.modalActionBtn.addEventListener('click', () => {
                closeModal();
                if (elements.modalActionBtn.dataset.action === 'restart') {
                    shufflePieces();
                    renderBoard();
                }
            });
            elements.modalCloseX.addEventListener('click', closeModal);
            elements.infoModal.addEventListener('click', (e) => {
                if (e.target === elements.infoModal) closeModal();
            });
        }

        // --- AI åŠŸèƒ½å¯¦ä½œ ---

        // 1. AI åœ–ç‰‡ç”Ÿæˆ (Imagen)
        async function handleAIGenerate() {
            const prompt = elements.aiPromptInput.value.trim();
            if (!prompt) {
                showModal('æç¤º', 'è«‹å…ˆè¼¸å…¥åœ–ç‰‡æè¿°å–”ï¼', false, true);
                return;
            }

            setLoading(true, "AI ç•«å®¶ä¸­...");

            try {
                // å»ºæ§‹ API è«‹æ±‚
                const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                const payload = {
                    instances: [{ prompt: prompt }],
                    parameters: { sampleCount: 1 }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');

                const data = await response.json();
                
                if (data.predictions && data.predictions[0] && data.predictions[0].bytesBase64Encoded) {
                    const base64Image = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    loadLevel(base64Image);
                    elements.levelSelect.value = ""; // æ¸…é™¤é¸å–®é¸å–ç‹€æ…‹
                    elements.aiPromptInput.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
                } else {
                    throw new Error('ç„¡æ³•è§£æåœ–ç‰‡è³‡æ–™');
                }

            } catch (error) {
                console.error(error);
                showModal('å“å‘€ï¼', 'AI ç”Ÿæˆåœ–ç‰‡æ™‚ç™¼ç”Ÿäº†ä¸€é»å•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚', false, true);
            } finally {
                setLoading(false);
            }
        }

        // 2. AI æ•™ç·´æç¤º (Gemini Text)
        async function handleAICoach() {
            setLoading(true, "AI æ€è€ƒä¸­...");

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                // æ ¹æ“šç•¶å‰æ˜¯å¦å®Œæˆæˆ–å‰›é–‹å§‹ï¼Œçµ¦äºˆä¸åŒæç¤º
                const userPrompt = "è«‹æ‰®æ¼”ä¸€ä½æ´»æ½‘æœ‰è¶£çš„æ‹¼åœ–æ•™ç·´ã€‚è«‹çµ¦æ­£åœ¨ç©æ‹¼åœ–éŠæˆ²çš„ç©å®¶ä¸€å¥ç°¡çŸ­çš„é¼“å‹µï¼Œæˆ–æ˜¯æä¾›ä¸€å€‹é€šç”¨çš„æ‹¼åœ–ç­–ç•¥ï¼ˆä¾‹å¦‚ï¼šå…ˆæŠŠé‚Šæ¡†æ‰¾å‡ºä¾†ã€ä¾ç…§é¡è‰²åˆ†é¡ç­‰ï¼‰ã€‚è«‹ä¸è¦è¶…é50å€‹å­—ï¼Œç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }]
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "åŠ æ²¹ï¼å†è©¦è©¦çœ‹ï¼";

                showModal('ğŸ¤– AI æ•™ç·´èªª...', aiText, false, true);

            } catch (error) {
                showModal('ç³»çµ±æç¤º', 'AI æ•™ç·´æš«æ™‚å»ä¼‘æ¯äº†ï¼Œè«‹é è‡ªå·±çš„åŠ›é‡åŠ æ²¹ï¼', false, true);
            } finally {
                setLoading(false);
            }
        }

        // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ ---

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    loadLevel(event.target.result);
                    elements.levelSelect.value = ""; 
                };
                reader.readAsDataURL(file);
            }
        }

        function loadLevel(imageUrl) {
            if(!imageUrl) return;
            state.currentImageUrl = imageUrl;
            elements.refImage.src = imageUrl;

            const img = new Image();
            img.onload = () => {
                calculateGrid(img.naturalWidth, img.naturalHeight);
                createPieces();
                shufflePieces();
                renderBoard();
            };
            img.onerror = () => {
                showModal("éŒ¯èª¤", "ç„¡æ³•è¼‰å…¥åœ–ç‰‡ï¼Œè«‹è©¦è©¦åˆ¥å¼µã€‚", false, true);
            };
            img.src = imageUrl;
        }

        function calculateGrid(width, height) {
            const aspectRatio = width / height;
            const targetTotal = 16; 
            let cols = Math.round(Math.sqrt(targetTotal * aspectRatio));
            let rows = Math.round(targetTotal / cols);
            state.cols = Math.max(2, cols);
            state.rows = Math.max(2, rows);

            elements.board.style.aspectRatio = `${width}/${height}`;
            elements.board.style.gridTemplateColumns = `repeat(${state.cols}, 1fr)`;
            elements.board.style.gridTemplateRows = `repeat(${state.rows}, 1fr)`;
        }

        function createPieces() {
            state.pieces = [];
            const total = state.rows * state.cols;
            for (let i = 0; i < total; i++) {
                state.pieces.push({ correctPos: i, id: i });
            }
        }

        function shufflePieces() {
            for (let i = state.pieces.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [state.pieces[i], state.pieces[j]] = [state.pieces[j], state.pieces[i]];
            }
            state.selectedPieceIndex = null;
        }

        function renderBoard() {
            elements.board.innerHTML = '';
            state.pieces.forEach((piece, index) => {
                const div = document.createElement('div');
                div.classList.add('puzzle-piece');
                div.dataset.index = index;
                
                const correctRow = Math.floor(piece.correctPos / state.cols);
                const correctCol = piece.correctPos % state.cols;
                
                const xPercent = state.cols > 1 ? (correctCol / (state.cols - 1)) * 100 : 0;
                const yPercent = state.rows > 1 ? (correctRow / (state.rows - 1)) * 100 : 0;

                div.style.backgroundImage = `url('${state.currentImageUrl}')`;
                div.style.backgroundSize = `${state.cols * 100}% ${state.rows * 100}%`;
                div.style.backgroundPosition = `${xPercent}% ${yPercent}%`;

                if (state.selectedPieceIndex === index) {
                    div.classList.add('selected');
                }
                addInteraction(div, index);
                elements.board.appendChild(div);
            });
        }

        function addInteraction(element, index) {
            element.setAttribute('draggable', true);

            element.addEventListener('dragstart', (e) => {
                state.isDragging = true;
                e.dataTransfer.setData('text/plain', index);
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => element.style.opacity = '0.5', 0);
            });

            element.addEventListener('dragend', () => {
                state.isDragging = false;
                element.style.opacity = '1';
                document.querySelectorAll('.puzzle-piece').forEach(p => p.style.transform = '');
            });

            element.addEventListener('dragover', (e) => {
                e.preventDefault(); 
                e.dataTransfer.dropEffect = 'move';
                element.style.transform = 'scale(0.95)';
            });

            element.addEventListener('dragleave', () => {
                element.style.transform = '';
            });

            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.style.transform = '';
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                if (fromIndex !== index) swapPieces(fromIndex, index);
            });

            element.addEventListener('click', (e) => {
                if (state.isDragging) return;
                if (state.selectedPieceIndex === null) {
                    state.selectedPieceIndex = index;
                    renderBoard();
                } else if (state.selectedPieceIndex === index) {
                    state.selectedPieceIndex = null;
                    renderBoard();
                } else {
                    swapPieces(state.selectedPieceIndex, index);
                    state.selectedPieceIndex = null;
                }
            });
        }

        function swapPieces(indexA, indexB) {
            [state.pieces[indexA], state.pieces[indexB]] = [state.pieces[indexB], state.pieces[indexA]];
            renderBoard();
            setTimeout(checkWin, 100);
        }

        function checkWin() {
            const isWin = state.pieces.every((piece, index) => piece.correctPos === index);
            if (isWin) {
                document.querySelectorAll('.puzzle-piece').forEach(p => {
                    p.style.border = 'none';
                    p.classList.add('correct-flash');
                });
                elements.board.style.gap = '0';
                
                // å‹åˆ©å¾Œä¹Ÿå¯ä»¥è«‹æ±‚ AI çµ¦äºˆè®šç¾ (é¸æ“‡æ€§åŠŸèƒ½ï¼Œé€™è£¡å…ˆç”¨ä¸€èˆ¬ Modal)
                setTimeout(() => {
                    showModal("ğŸ‰ æ­å–œå®Œæˆï¼", "ä½ æˆåŠŸæ‹¼å‡ºäº†å®Œæ•´çš„åœ–ç‰‡ï¼å¤ªæ£’äº†ï¼", true, false);
                }, 500);
            }
        }

        // --- å·¥å…·å‡½å¼ ---

        function setLoading(isLoading, text = "Loading...") {
            state.isLoading = isLoading;
            elements.loadingOverlay.style.display = isLoading ? 'flex' : 'none';
            elements.loadingText.textContent = text;
            elements.board.classList.toggle('loading', isLoading);
            
            // åœç”¨/å•Ÿç”¨æŒ‰éˆ•
            elements.aiGenBtn.disabled = isLoading;
            elements.aiCoachBtn.disabled = isLoading;
        }

        function showModal(title, text, isWin = false, isAI = false) {
            elements.modalTitle.textContent = title;
            elements.modalText.textContent = text;
            elements.infoModal.style.display = 'flex';
            
            // æ¨£å¼èª¿æ•´
            if (isAI) {
                elements.modalContentBox.classList.add('ai-style');
                elements.modalActionBtn.textContent = "å¥½çš„";
                elements.modalActionBtn.dataset.action = "close";
            } else {
                elements.modalContentBox.classList.remove('ai-style');
            }

            if (isWin) {
                elements.modalActionBtn.textContent = "å†ç©ä¸€æ¬¡";
                elements.modalActionBtn.dataset.action = "restart";
            } else if (!isAI) {
                elements.modalActionBtn.textContent = "ç¢ºå®š";
                elements.modalActionBtn.dataset.action = "close";
            }
        }

    </script>
</body>
</html>